{"version":3,"sources":["../../../src/coooders/collection/pool.js"],"names":["Pool","size","func","waitTime","that","pri","data","have","wait","use","KEY","addUse","v","isValid","__","random","delUse","_","clear","Clearer","start","callback","pop","value","call","length","callback2","then","push","endDate","Date","add","dispose","shift","tryC","stop","i","pris","obj","objpri","tid","datas","diff","val","global","setTimeout","ret","check","clearTimeout"],"mappings":"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","file":"pool.js","sourcesContent":["import V from '../common/tool';\n/**\n * 仅限于池方式调用的方法\n * @author(baibing)\n * @param('size','')\n * @param(func:创建对象的方法)\n * @param(waitTime,过期时间)\n */\nexport const Pool = class {\n    constructor(size = 10, func, waitTime = 10) {\n        const that = this;\n        const { _, __ } = pri(that, {\n            size,\n            func,\n            waitTime,\n            data: [], //总数\n            have: [], //有可用资源\n            wait: [], //等待调用的请求\n            use: {}, //使用中的\n            KEY: Symbol('_____poolid'),\n            addUse: (v) => {\n                if (v) {\n                    if (!V.isValid(v[__.KEY])) {\n                        v[__.KEY] = V.random();\n                    }\n                    __.use[v[__.KEY]] = v;\n                }\n            },\n            delUse: (v) => {\n                if (v && V.isValid(v[__.KEY])) {\n                    delete __.use[v[__.KEY]];\n                }\n            }\n        });\n        __.clear = new Clearer(_, __);\n        __.clear.start();\n    }\n    getValue() {\n        const { _, __ } = pri(this);\n        return V.callback(call => {\n            let v = __.have.pop();\n            if (v) {\n                v = v.value;\n                __.addUse(v);\n                call(null, v);\n            } else if (__.data.length < __.size) {\n                V.callback2(__.func, __).then(v => {\n                    __.addUse(v);\n                    __.data.push(v);\n                    call(null, v);\n                });\n            } else {\n                __.wait.push({ endDate: new Date().add('s', __.waitTime), value: call, dispose: call });\n            }\n        });\n    }\n    setValue(v) {\n        const { _, __ } = pri(this);\n        if (V.isValid(v) && V.isValid(v[__.KEY])) {\n            if (__.wait.length > 0) { //仅针对getValue异步操作有效\n                __.wait.shift().value(null, v);\n            } else {\n                __.delUse(v);\n                __.have.push({\n                    endDate: new Date().add('s', __.waitTime),\n                    value: v,\n                    dispose: function() {\n                        if (v.dispose) V.tryC(v.dispose);\n                    }\n                });\n            }\n        }\n    }\n    dispose() {\n        const { _, __ } = pri(this);\n        __.clear.stop();\n        for (let i in __.data) V.tryC(() => { if (__.data[i].dispose) __.data[i].dispose() });\n        for (let i in __.wait) V.tryC(() => { if (__.wait[i].dispose) __.wait[i].dispose() });\n        __.data = null;\n        __.have = null;\n        __.use = null;\n    }\n};\nexport default { Pool };\nconst pri = V.pris();\nclass Clearer {\n    constructor(obj, objpri) {\n        const { _, __ } = pri(this, { obj: obj, pri: objpri });\n        this.tid = null;\n    }\n    check(datas) {\n        let endDate = datas.length > 0 ? datas[0].endDate : null;\n        if (V.isValid(endDate) && new Date().diff('ms', endDate) > 0) {\n            return false;\n        } else {\n            while (datas.length > 0) {\n                let val = datas.shift();\n                if (V.isValid(val.endDate) && new Date().diff('ms', val.endDate) <= 0) {\n                    if (val.dispose) {\n                        V.tryC(val.dispose);\n                    }\n                } else return true;\n                val = null;\n            }\n            return true;\n        }\n    }\n    start() {\n        const { _, __ } = pri(this);\n        _.tid = global.setTimeout(() => {\n                let ret = _.check(__.pri.have);\n                _.check(__.pri.wait);\n                _.start();\n            },\n            500);\n    }\n    stop() {\n        const _ = this;\n        if (_.tid)\n            global.clearTimeout(_.tid);\n        _.tid = null;\n    }\n};"]}